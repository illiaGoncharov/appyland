#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è —Å–∞–π—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä
# 
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
# 1. –ù–∞—Å—Ç—Ä–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∏–∂–µ –ø–æ–¥ —Å–≤–æ–π —Å–µ—Ä–≤–µ—Ä
# 2. –ó–∞–ø—É—Å—Ç–∏: ./deploy-to-server.sh

# ================================
# –ù–ê–°–¢–†–û–ô–ö–ò (–∑–∞–ø–æ–ª–Ω–∏ —Å–≤–æ–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
# ================================

SERVER_USER="your_user"              # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
SERVER_HOST="your-server.com"        # –ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞
SERVER_PATH="/var/www/appyland"      # –ü—É—Ç—å –∫ —Å–∞–π—Ç—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

# ================================
# –î–ï–ü–õ–û–ô
# ================================

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Å–µ—Ä–≤–µ—Ä..."
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã
if [[ -n $(git status -s) ]]; then
  echo "‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: –µ—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è!"
  echo "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –≤—Å—ë –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º."
  read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏..."

# –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è —Å–±–æ—Ä–∫–∏
BUILD_DIR="build_prod"
rm -rf $BUILD_DIR
mkdir -p $BUILD_DIR

# –ö–æ–ø–∏—Ä—É–µ–º –≤—Å—ë –Ω—É–∂–Ω–æ–µ (–∏—Å–∫–ª—é—á–∞—è .git, node_modules –∏ —Ç.–¥.)
rsync -av \
  --exclude='.git' \
  --exclude='.gitignore' \
  --exclude='node_modules' \
  --exclude='build_prod' \
  --exclude='*.sh' \
  --exclude='*.md' \
  --exclude='.DS_Store' \
  ./ $BUILD_DIR/

echo ""
echo "üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä $SERVER_HOST..."
echo ""

# –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
rsync -avz --delete \
  $BUILD_DIR/ \
  $SERVER_USER@$SERVER_HOST:$SERVER_PATH/

# –û—á–∏—Å—Ç–∫–∞
rm -rf $BUILD_DIR

echo ""
echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
echo "–°–∞–π—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–∞: $SERVER_HOST"
echo ""

