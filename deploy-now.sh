#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ production —Å–µ—Ä–≤–µ—Ä
# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: 
# 1. –ó–∞–ø–æ–ª–Ω–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∏–∂–µ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ GitLab CI/CD Variables
# 2. –ó–∞–ø—É—Å—Ç–∏: chmod +x deploy-now.sh && ./deploy-now.sh

# ========================================
# –ó–ê–ü–û–õ–ù–ò –≠–¢–ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò–ó GITLAB
# ========================================

# –ò–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π HOST_PROD (–Ω–∞–ø—Ä–∏–º–µ—Ä: appyland.ru –∏–ª–∏ 123.45.67.89)
SERVER_HOST=""

# –ò–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π PORT_PROD (–æ–±—ã—á–Ω–æ 22)
SERVER_PORT=""

# –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ HOST_GGPA_PROD –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ)
SERVER_USER=""

# –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å–∞–π—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: /var/www/appyland)
SERVER_PATH=""

# ========================================
# –ü–†–û–í–ï–†–ö–ê
# ========================================

if [ -z "$SERVER_HOST" ] || [ -z "$SERVER_USER" ] || [ -z "$SERVER_PATH" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: –∑–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞!"
  echo ""
  echo "–ù—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å:"
  echo "  SERVER_HOST - –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞"
  echo "  SERVER_USER - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å SSH"
  echo "  SERVER_PATH - –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å–∞–π—Ç–∞"
  exit 1
fi

if [ -z "$SERVER_PORT" ]; then
  SERVER_PORT=22
fi

echo "üöÄ –î–µ–ø–ª–æ–π –Ω–∞ production —Å–µ—Ä–≤–µ—Ä"
echo "================================"
echo "–°–µ—Ä–≤–µ—Ä: $SERVER_USER@$SERVER_HOST:$SERVER_PORT"
echo "–ü—É—Ç—å: $SERVER_PATH"
echo ""

# ========================================
# –î–ï–ü–õ–û–ô
# ========================================

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ dist —Å–æ–±—Ä–∞–Ω
if [ ! -d "dist" ]; then
  echo "üì¶ –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
  npm run build:hosting
fi

echo "üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
echo ""

# –ó–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä–µ–∑ rsync
rsync -avz --delete \
  -e "ssh -p $SERVER_PORT" \
  dist/ \
  $SERVER_USER@$SERVER_HOST:$SERVER_PATH/

if [ $? -eq 0 ]; then
  echo ""
  echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!"
  echo "–°–∞–π—Ç –æ–±–Ω–æ–≤–ª—ë–Ω: https://appyland.ru"
else
  echo ""
  echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ!"
  echo "–ü—Ä–æ–≤–µ—Ä—å SSH –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É."
fi

